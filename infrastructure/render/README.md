# BlaidTrades Render Deployment Guide

Deploy BlaidTrades to Render for a production-ready, scalable trading platform.

## Prerequisites

1. **Render Account** - Sign up at [render.com](https://render.com)
2. **GitHub Repository** - Push this codebase to GitHub (or use Replit's GitHub sync)

## Estimated Costs

| Service | Plan | Monthly Cost |
|---------|------|--------------|
| Web Service (API) | Standard | $25-85 |
| Worker Service | Standard | $25-85 |
| PostgreSQL | Pro | $50-100 |
| Redis | Standard | $10-30 |
| **Total** | | **$110-300** |

## Deployment Steps

### Step 1: Connect GitHub to Render

1. Go to [dashboard.render.com](https://dashboard.render.com)
2. Click **"New"** → **"Blueprint"**
3. Connect your GitHub account
4. Select your BlaidTrades repository
5. Render will auto-detect the `render.yaml` file

### Step 2: Wait for Initial Deploy

The blueprint will automatically:
- Create PostgreSQL database
- Create Redis instance
- Deploy API service
- Deploy Worker service
- **Run database migrations** (via `preDeployCommand`)

### Step 3: Configure Environment Variables

Go to Render Dashboard and add your API keys to **BOTH** the API and Worker services.

---

## Production Secrets Matrix

### Auto-Generated by Render (No Action Needed)
| Variable | Service | Notes |
|----------|---------|-------|
| `DATABASE_URL` | API, Worker | Auto-linked from PostgreSQL |
| `REDIS_URL` | API, Worker | Auto-linked from Redis |
| `SESSION_SECRET` | API, Worker | Auto-generated on deploy |
| `JWT_SECRET` | API, Worker | Auto-generated on deploy |
| `ENCRYPTION_KEY` | API, Worker | Auto-generated on deploy |

### Required API Keys (Must Set Manually)

#### Core AI Providers (Set on BOTH API and Worker)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `OPENAI_API_KEY` | Yes | [platform.openai.com](https://platform.openai.com) | Primary AI fallback |
| `ANTHROPIC_API_KEY` | Yes | [console.anthropic.com](https://console.anthropic.com) | Claude models |
| `GROQ_API_KEY` | Yes | [console.groq.com](https://console.groq.com) | Fast inference, primary cascade |

#### Market Data Providers (Set on BOTH API and Worker)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `DATABENTO_API_KEY` | Yes | [databento.com](https://databento.com) | CME futures data (critical) |
| `POLYGON_API_KEY` | Recommended | [polygon.io](https://polygon.io) | Backup market data |
| `FINNHUB_API_KEY` | Recommended | [finnhub.io](https://finnhub.io) | News and sentiment |
| `FMP_API_KEY` | Recommended | [financialmodelingprep.com](https://financialmodelingprep.com) | Economic calendar |
| `FRED_API_KEY` | Recommended | [fred.stlouisfed.org](https://fred.stlouisfed.org) | Federal Reserve data |

#### Optional AI Providers (Set on API only)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `XAI_API_KEY` | Optional | [x.ai](https://x.ai) | Grok models for research |
| `GOOGLE_GEMINI_API_KEY` | Optional | [ai.google.dev](https://ai.google.dev) | Gemini fallback |
| `PERPLEXITY_API_KEY` | Optional | [perplexity.ai](https://perplexity.ai) | Deep research |

#### Optional Data Providers (Set on API only)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `NEWS_API_KEY` | Optional | [newsapi.org](https://newsapi.org) | Additional news sources |
| `MARKETAUX_API_KEY` | Optional | [marketaux.com](https://marketaux.com) | Market news |
| `UNUSUAL_WHALES_API_KEY` | Optional | [unusualwhales.com](https://unusualwhales.com) | Options flow |
| `ALPHAVANTAGE_API_KEY` | Optional | [alphavantage.co](https://alphavantage.co) | Backup data |

#### Google OAuth (Set on API only - for Google Drive backup)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `GOOGLE_CLIENT_ID` | Optional | [console.cloud.google.com](https://console.cloud.google.com) | OAuth for Drive backup |
| `GOOGLE_CLIENT_SECRET` | Optional | [console.cloud.google.com](https://console.cloud.google.com) | OAuth for Drive backup |

#### Live Trading Credentials (Set on API only - ONLY if going live)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `IRONBEAM_USERNAME_1` | For Live | Ironbeam account | Live trading only |
| `IRONBEAM_PASSWORD_1` | For Live | Ironbeam account | Live trading only |
| `IRONBEAM_API_KEY_1` | For Live | Ironbeam account | Live trading only |
| `TRADOVATE_USERNAME` | For Live | Tradovate account | Alternative broker |
| `TRADOVATE_PASSWORD` | For Live | Tradovate account | Alternative broker |
| `TRADOVATE_APP_ID` | For Live | Tradovate account | Alternative broker |

#### Notifications (Set on API only)
| Variable | Required | Source | Notes |
|----------|----------|--------|-------|
| `DISCORD_WEBHOOK_URL` | Optional | Discord server settings | Alert notifications |

---

## Production Verification Runbook

After deploy completes, verify each component:

### 1. API Health Check
```bash
curl https://YOUR-APP.onrender.com/api/health
```
Expected: `{"status":"ok","timestamp":"..."}`

### 2. Database Connection
```bash
curl https://YOUR-APP.onrender.com/api/health-summary
```
Expected: Response with database stats (may take a few seconds)

### 3. Authentication Test
1. Navigate to `https://YOUR-APP.onrender.com`
2. Login with your credentials
3. Verify dashboard loads with bots

### 4. WebSocket Connectivity
1. Open browser DevTools (F12)
2. Check Console for: `[LIVE_PNL_PROVIDER] WebSocket connected`
3. Should NOT see repeated AUTH_ERROR messages

### 5. Background Workers
1. Go to Render Dashboard → blaidtrades-worker → Logs
2. Look for: `[BACKTEST_WORKER]` or `[RUNNER_WORKER]` messages
3. Verify workers are processing jobs

### 6. Market Data (During Market Hours)
1. Check Strategy Lab page loads
2. Verify bots show real-time P&L updates
3. Look for `[DATABENTO]` logs in worker

### Quick Health Check Script
```bash
# Run this after deploy
APP_URL="https://YOUR-APP.onrender.com"

echo "1. Checking API health..."
curl -s "$APP_URL/api/health" | jq .

echo "2. Checking integrations..."
curl -s "$APP_URL/api/integrations/status" | jq '.providers | keys'

echo "3. Checking auth endpoint..."
curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/auth/session"
```

---

## Architecture on Render

```
┌─────────────────────────────────────────────────────┐
│                    Internet                          │
└─────────────────────┬───────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────┐
│              Render Load Balancer                    │
│              (SSL termination)                       │
└─────────────────────┬───────────────────────────────┘
                      │
         ┌────────────┴────────────┐
         │                         │
┌────────▼────────┐       ┌────────▼────────┐
│  blaidtrades-   │       │  blaidtrades-   │
│      api        │       │     worker      │
│  (Web Service)  │       │ (Background)    │
│  1-3 instances  │       │  1-3 instances  │
└────────┬────────┘       └────────┬────────┘
         │                         │
         └────────────┬────────────┘
                      │
         ┌────────────┴────────────┐
         │                         │
┌────────▼────────┐       ┌────────▼────────┐
│  PostgreSQL     │       │     Redis       │
│  (Pro Plan)     │       │   (Standard)    │
│  Managed DB     │       │  Cache/Queue    │
└─────────────────┘       └─────────────────┘
```

## Scaling

Render auto-scales based on:
- **CPU**: Scales up when CPU exceeds 70%
- **Memory**: Scales up when memory exceeds 80%

Manual scaling:
1. Go to service → **"Settings"**
2. Adjust **"Instance Count"** min/max

## Monitoring

Render provides built-in:
- **Logs**: Real-time log streaming
- **Metrics**: CPU, Memory, Request count
- **Alerts**: Configure in Dashboard → Notifications

## Troubleshooting

### Database Connection Issues
- Check `DATABASE_URL` is set correctly
- Verify PostgreSQL service is running
- Check connection pool limits (default: 20)

### Worker Not Processing Jobs
- Check Redis connection
- Verify `WORKER_MODE=true` is set
- Check worker logs for errors

### Slow Response Times
- Scale up instances
- Check database query performance
- Verify Redis is being used for caching

### WebSocket Disconnects
- Normal in Render's load balancer environment
- Client auto-reconnects, no action needed

## Migration from Replit

1. Export your current database:
   ```bash
   pg_dump $DATABASE_URL > backup.sql
   ```

2. Import to Render PostgreSQL:
   ```bash
   psql $RENDER_DATABASE_URL < backup.sql
   ```

3. Update DNS to point to Render URL

## Support

- Render Docs: [render.com/docs](https://render.com/docs)
- Render Status: [status.render.com](https://status.render.com)
